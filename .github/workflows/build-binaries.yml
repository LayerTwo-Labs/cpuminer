name: Build Multi-Platform Binaries

on:
  push:
    branches: [ main, master ]
    tags:
      - 'v*'
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

env:
  DOCKERFILE: Dockerfile.crossbuild
  OUTPUT_DIR: binaries

jobs:
  # Build Linux x86_64
  build-linux-x86_64:
    name: Build Linux x86_64
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build Linux x86_64 binary
        run: |
          docker build -f ${DOCKERFILE} --target linux-x86_64 -t cpuminer-linux-x86_64 --load .
          docker create --name cpuminer-linux-x86_64 cpuminer-linux-x86_64
          docker cp cpuminer-linux-x86_64:/build/output/minerd-linux-x86_64 ./${OUTPUT_DIR}/
          docker rm cpuminer-linux-x86_64

      - name: Upload Linux x86_64 binary
        uses: actions/upload-artifact@v4
        with:
          name: minerd-linux-x86_64
          path: binaries/minerd-linux-x86_64
          retention-days: 30

  # Build Linux i686
  build-linux-i686:
    name: Build Linux i686
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build Linux i686 binary
        run: |
          docker build -f ${DOCKERFILE} --target linux-i686 -t cpuminer-linux-i686 --load .
          docker create --name cpuminer-linux-i686 cpuminer-linux-i686
          docker cp cpuminer-linux-i686:/build/output/minerd-linux-i686 ./${OUTPUT_DIR}/
          docker rm cpuminer-linux-i686

      - name: Upload Linux i686 binary
        uses: actions/upload-artifact@v4
        with:
          name: minerd-linux-i686
          path: binaries/minerd-linux-i686
          retention-days: 30

  # Build Windows x86_64
  build-windows-x86_64:
    name: Build Windows x86_64
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build Windows x86_64 binary
        run: |
          docker build -f ${DOCKERFILE} --target windows-x86_64 -t cpuminer-windows-x86_64 --load .
          docker create --name cpuminer-windows-x86_64 cpuminer-windows-x86_64
          docker cp cpuminer-windows-x86_64:/build/output/minerd-windows-x86_64.exe ./${OUTPUT_DIR}/
          docker rm cpuminer-windows-x86_64

      - name: Upload Windows x86_64 binary
        uses: actions/upload-artifact@v4
        with:
          name: minerd-windows-x86_64
          path: binaries/minerd-windows-x86_64.exe
          retention-days: 30

  # Build Windows i686
  build-windows-i686:
    name: Build Windows i686
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build Windows i686 binary
        run: |
          docker build -f ${DOCKERFILE} --target windows-i686 -t cpuminer-windows-i686 --load .
          docker create --name cpuminer-windows-i686 cpuminer-windows-i686
          docker cp cpuminer-windows-i686:/build/output/minerd-windows-i686.exe ./${OUTPUT_DIR}/
          docker rm cpuminer-windows-i686

      - name: Upload Windows i686 binary
        uses: actions/upload-artifact@v4
        with:
          name: minerd-windows-i686
          path: binaries/minerd-windows-i686.exe
          retention-days: 30

  # Build macOS x86_64 (native build on macOS runner)
  build-macos-x86_64:
    name: Build macOS x86_64
    runs-on: macos-13
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          # Install required build tools
          brew install autoconf automake libtool pkg-config curl || true

      - name: Build macOS x86_64 binary
        run: |
          mkdir -p ${OUTPUT_DIR}
          ./autogen.sh
          ./configure CFLAGS="-O3" --host=x86_64-apple-darwin
          make clean
          make -j$(sysctl -n hw.ncpu)
          cp minerd ${OUTPUT_DIR}/minerd-macos-x86_64

      - name: Upload macOS x86_64 binary
        uses: actions/upload-artifact@v4
        with:
          name: minerd-macos-x86_64
          path: binaries/minerd-macos-x86_64
          retention-days: 30

  # Build macOS arm64 (native build on macOS runner)
  build-macos-arm64:
    name: Build macOS arm64
    runs-on: macos-13  # macos-13 supports both x86_64 and arm64 via cross-compilation
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          # Install required build tools
          brew install autoconf automake libtool pkg-config curl || true

      - name: Build macOS arm64 binary
        run: |
          mkdir -p ${OUTPUT_DIR}
          ./autogen.sh
          # Build for arm64 architecture
          ./configure CFLAGS="-O3 -arch arm64" --host=arm64-apple-darwin
          make clean
          make -j$(sysctl -n hw.ncpu)
          cp minerd ${OUTPUT_DIR}/minerd-macos-arm64

      - name: Upload macOS arm64 binary
        uses: actions/upload-artifact@v4
        with:
          name: minerd-macos-arm64
          path: binaries/minerd-macos-arm64
          retention-days: 30

  # Collect all binaries and create release
  create-release:
    name: Create Release
    runs-on: ubuntu-latest
    needs: [build-linux-x86_64, build-linux-i686, build-windows-x86_64, build-windows-i686, build-macos-x86_64, build-macos-arm64]
    if: startsWith(github.ref, 'refs/tags/v')
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: release-binaries

      - name: Prepare release assets
        run: |
          mkdir -p release
          cd release-binaries
          
          # Find and copy all binaries
          find . -name "minerd-*" -type f -exec cp {} ../release/ \;
          
          # Create checksums
          cd ../release
          for file in *; do
            sha256sum "$file" > "${file}.sha256"
          done
          
          # Create archive with all binaries
          cd ..
          tar czf cpuminer-binaries-all.tar.gz -C release .
          zip -r cpuminer-binaries-all.zip release/

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          files: |
            release/cpuminer-binaries-all.tar.gz
            release/cpuminer-binaries-all.zip
            release/*.sha256
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # Summary job to show build status
  build-summary:
    name: Build Summary
    runs-on: ubuntu-latest
    needs: [build-linux-x86_64, build-linux-i686, build-windows-x86_64, build-windows-i686, build-macos-x86_64, build-macos-arm64]
    if: always()
    steps:
      - name: Build Summary
        run: |
          echo "## Build Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Platform | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Linux x86_64 | ${{ needs.build-linux-x86_64.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Linux i686 | ${{ needs.build-linux-i686.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Windows x86_64 | ${{ needs.build-windows-x86_64.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Windows i686 | ${{ needs.build-windows-i686.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| macOS x86_64 | ${{ needs.build-macos-x86_64.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| macOS arm64 | ${{ needs.build-macos-arm64.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "All binaries are available as build artifacts."

